<link rel="import" href="../polymer/polymer.html">


<!--
`<awesome-sauce>` injects a healthy dose of awesome into your page.

In typical use, just slap some `<awesome-sauce>` at the top of your body:

    <body>
      <awesome-sauce></awesome-sauce>

Wham! It's all awesome now!
-->

<dom-module id="video-tagging">


  <template>
    
    <link rel="stylesheet" href="video-tagging.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" />
    <div id="controlWrapper" style="width:100%;height:100%;border-width: 0px;border-style: solid;border-color: green;">
        <div id='videoWrapper'  style="border-width: 0px;border-style: solid;border-color: blue;">
          
          <canvas id="overlay"  on-click='videoClicked' class = "overlaystyle" >
                  Your browser does not support the HTML5 canvas tag.</canvas>
          <video id='vid'>
                     
                   Your browser does not support the video tag.</video>
        </div>
    
    <div id="video-controls" >

      <div id='first-row'>
          <button type="button" on-click='stepbwdclicked' class='btn btn-primary' id="stepbwd" >&laquo;</button>

          <button type="button" on-click='playclicked' class='btn btn-primary btn3d' style="width:80px" id="play-pause">Play</button>
          <button type="button" on-tap='stepfwdclicked'  class='btn btn-primary' id="stepfwd" >&raquo;</button>
          <span id='framespan' style='padding-left:20px'>Frame :</span>
          <span id='frameText' style='padding-right:20px;color:blue'>0</span>
          <button type="button" class='btn btn-primary' id="autostep" on-click='autostepclicked' >Enable Auto Step</button>
          <span id='stepspan' style='padding-left:20px'>Step :</span>
          <span id='stepText' style='padding-right:20px;color:blue'>0</span>

          <button type="button" class='btn btn-primary' id="emptyTagButton" on-click='emptyTagClicked' >Empty Tag</button>
      </div>
      <div id="playback">
        <span>Playback Rate :</span>
        <input type="radio" name='playbackRate'  checked  class='radio-inline' value=1 on-click='playback' style='margin-left:40px'> x 1</input>
        <input type="radio" name='playbackRate' class='radio-inline' value=.5 on-click='playback'> x 0.5 </input>
        <input type="radio" name='playbackRate' class='radio-inline' value=.25 on-click='playback'> x 0.25 </input>
        <input type="radio" name='playbackRate' class='radio-inline' value=.1 on-click='playback'> x 0.1 </input>
        <input type="radio" name='playbackRate' class='radio-inline' value=.05 on-click='playback'> x 0.05 </input>

</div>
  <fieldset class="fields">
    <div class="form-inline"> 
        <span class="input_button"><output for="seek-bar" id="curtimespan">0</output></span>

        <input id="seek-bar" type="range" min='0' value="0" step=.01 required />
        
        <span class="input_button"><output for="seek-bar" id="remainingtimespan">30</output></span>

    </div>

          <div > 
            

    </div>
  </fieldset>
   </div> 
  </div> 
</template>

<script>

  Polymer({

    is: 'video-tagging',

    properties: {

      framerate: Number,
      videoduration: Number,
      shape: String,
      multitags: Number,
      tagsize: Number,
      
      count: {
        type: Number,
        readOnly: true,
        notify: true
      },
      src: {
        type: String,
        value: '',
        observer: 'srcChanged'
      }

    },
    // Element Lifecycle
    ready: function() {
      this.frames = {};
      this.fbfinterval = null;
      this.fbf = false;
      this.seeking = false;
    
      this.autoStepEnabled = false;
      this.step = 29;

      this.videoWrapper= document.getElementById('videoWrapper');
      this.overlay = document.getElementById('overlay');
      this.video= document.getElementById('vid');

      this.currentTimeSpan = document.getElementById("curtimespan");
      this.remainingTimeSpan = document.getElementById("remainingtimespan");
      this.stepText = document.getElementById("stepText");
      this.frameText = document.getElementById("frameText");

      // Buttons
      this.playButton = document.getElementById("play-pause");
      this.framefwdButton = document.getElementById("framefwd");
      this.framebwdButton = document.getElementById("framebwd");
      this.autoStepButton = document.getElementById("autostep");
      this.playbackRateButton1 = document.getElementById("playbackRate");

      // Sliders
      this.seekBar = document.getElementById("seek-bar");

      this.playing = null;
      this.ctx = this.overlay.getContext("2d");

    },
    srcChanged: function(newValue, oldValue) { 

          if(this.video)
          {
              this.video.src = newValue;
          }
     },
    attached: function() {

      this.autoStepButton.style.visibility = this.multitags == 0?'visible':'hidden';
      this.frameTime = 1/this.framerate;
      this.video.src = this.src;
      
      //Calculate size of canvas to fit video.
      var self = this;
      this.video.addEventListener( "loadedmetadata", function (e) {
            
            self.overlay.width = $('#vid').width();
            self.overlay.height = $('#vid').height();
            self.seekBar.max = self.video.duration;
            self.remainingTimeSpan.innerHTML = self.video.duration

      }, false );
      
      this.seekBar.addEventListener("mousedown", function() {
            
            self.seeking = true;
          });
      this.seekBar.addEventListener("mouseup", function() {
            
            self.seeking = false;
          });
      
      this.seekBar.addEventListener("change", function() {
            self.seeking = false;
            self.video.currentTime = self.seekBar.value;
            self.playingCallback();

          });        
    },
    detached: function() {
    },
    playback: function(e) {
      this.video.playbackRate = e.toElement.value;
    },
    playclicked: function() {
      this.video.paused?this.playState():this.pauseState();
    },
    stepfwdclicked: function() {
      this.pauseState();
      this.video.currentTime = Math.min(this.video.duration, this.video.currentTime + this.frameTime);
      this.playingCallback();
    },
    stepbwdclicked: function() {
        this.pauseState();
        if (this.video.currentTime > 0) {
            //one frame back
            this.video.currentTime -= this.frameTime;
            this.playingCallback();
        }
    },
    autostepclicked: function() {

          if (this.autoStepEnabled) {
            this.autoStepEnabled = false;
            this.autoStepButton.innerHTML = "Enable Auto Step";
            
          } else {
            this.pauseState();
            this.autoStepButton.innerHTML = "Disable Auto Step";
            this.autoStepEnabled = true;
          }
    },
    videoClicked: function(e) {
            
            var offset = $(this).offset();
            var relativeX = (e.pageX - offset.left);
            var relativeY = (e.pageY - offset.top);
            //Add to tags collection
            this.addTag(relativeX, relativeY, this.shape, this.multitags == 1);
            //Draws the rectangle
            this.drawTag(relativeX, relativeY);
            if(this.autoStepEnabled)
            {
                var self = this;
                setTimeout(function(){ self.stepfwdclicked(); }, 1000);
            }
    },
    emptyTagClicked: function(e)
    {
           this.clearOverlay();
           this.addTag(null, null, 'empty', false);
    },
    findTag: function() {
            this.clearOverlay();//Clear canvas
            var offset = $(this).offset();
            var frameIndex = this.getCurrentFrame();
            
            if(this.frames[frameIndex])
            {
              console.log('found')
              //Draw all tags for this frame
              for (i = 0; i < this.frames[frameIndex].length; i++) {

                  var arr = this.frames[frameIndex][i]; 
                  //Calculate x, y relative to current width and height          
                  var widthRatio = arr.width / $('#vid').width();
                  var x = (arr.x / widthRatio);
                  var heightRatio = arr.height / $('#vid').height();
                  var y = (arr.y / heightRatio);
                  
                  this.drawTag( x, y);
              }
            }
    },    
    clearOverlay: function() {

      this.ctx.clearRect(0, 0, this.overlay.width, this.overlay.height);
    },
    getCurrentFrame: function() {
      return Math.round(this.video.currentTime * this.framerate);
    },
    playState: function() {
        this.video.play();
        
        this.playButton.innerHTML = "Pause";
        this.autoStepEnabled = false;
        this.autoStepButton.innerHTML = "Enable Auto Step";    
        var self = this;
        this.playing = setInterval(function() {
            self.playingCallback();
        }, 10);
    },
    pauseState: function() {
            this.video.pause();
            this.playButton.innerHTML = "Play";         
            clearInterval(this.playing);
    },
    addTag: function(x, y, type, allowMultiple) {
            
            console.log(x + "_" + y )

            var arr = {};
            arr.width = $('#vid').width();
            arr.height = $('#vid').height();
            arr.x = x;
            arr.y = y;
            arr.type = type;
            
            var frameIndex = this.getCurrentFrame();
            if(allowMultiple && this.frames[frameIndex] != null)
            {
                this.frames[frameIndex].push(arr);
            }
            else
            {
                this.clearOverlay();
                var tagArray = [];
                tagArray.push(arr);
                this.frames[frameIndex] = tagArray;
            }
            //console.log(this.frames)
            //this.fire('tagged', {tag: arr});
    },
    drawTag: function(x, y) {

            if(this.shape == "rectangle")
            {
                this.ctx.strokeRect(x - this.tagsize/2, y - this.tagsize/2, this.tagsize, this.tagsize);
            }
            if(this.shape == "circle")
            {
                this.ctx.beginPath();
                this.ctx.arc(x,y,this.tagsize,0,2*Math.PI, false);
                this.ctx.stroke();
                this.ctx.closePath();
            }
            if(this.shape == "x")
            {
                this.ctx.beginPath();
                this.ctx.moveTo(x + this.tagsize/2, y + this.tagsize/2);
                this.ctx.lineTo(x - this.tagsize/2, y - this.tagsize/2);
                this.ctx.moveTo(x + this.tagsize/2, y - this.tagsize/2);
                this.ctx.lineTo(x - this.tagsize/2, y + this.tagsize/2);
                this.ctx.stroke();
                this.ctx.closePath();
            }
    },
    playingCallback: function() {
            
            var frameIndex = this.getCurrentFrame();
            this.frameText.innerHTML = frameIndex;
            
            this.currentTimeSpan.innerHTML = this.video.currentTime.toFixed(2);
            this.remainingTimeSpan.innerHTML = (this.video.duration - this.video.currentTime).toPrecision(3);
            if(!this.seeking)
            {
                this.seekBar.value = this.video.currentTime;
            }
            this.findTag();
        }
  });

</script>
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script> 

</dom-module>
